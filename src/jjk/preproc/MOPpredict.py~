#!/usr/cadc/misc/bin/python

import orbfit
import sys
import ephem

name = sys.argv[1]
date = ephem.julian_date(sys.argv[2])
obs = 568
fitsImage=sys.argv[3]

(ra,dec,dra,ddec,dang)=orbfit.predict("/home/cadc/kavelaar/dbase/TNOdb/dbase/data/orbb/"+name+".abg",
                     date,obs)

print ra,dec, dra, ddec, dang

import wcsutil
import pyfits
import os, math

f = pyfits.open(fitsImage)
wcsObject = wcsutil.WCSObject(f[0].header)
(x,y)=wcsObject.rd2xy((ra,dec))
if x < f[0].header['NAXIS1'] and x > 0 and y < f[0].header['NAXIS2'] and y >0 :
    x1=math.floor(max(x-1000,1))
    x2=math.floor(min(x+1000,f[0].header['NAXIS1']))
    y1=math.floor(max(y-1000,1))
    y2=math.floor(min(y+1000,f[0].header['NAXIS2']))
else:
    sys.exit(0)

cmd='imcopy %s[%d:%d,%d:%d] - | xpaset ds9 fits new ' % ( fitsImage,x1,x2,y1,y2)

print cmd
os.system(cmd)
a = (math.cos(math.radians(dang))*dra + math.sin(math.radians(dang))*ddec)/3600.0
b = (math.cos(math.radians(dang))*ddec - math.sin(math.radians(dang))*dra)/3600.0
cmd = 'echo "icrs; ellipse %f %f %f %f" | xpaset ds9 regions' % ( ra, dec, a, b)
print cmd
os.system(cmd)

os.system("xpaget ds9 imexam coordinate wcs icrs sexagesimal")
