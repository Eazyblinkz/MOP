#!/usr/cadc/misc/bin/python

import math
import mop_files
import sys

basename=sys.argv[1]

files=[]
files.append(mop_files.read(basename+'.obj.jmp'))
files.append(mop_files.read(basename+'.obj.matt'))

x=(files[0]['data']['X'],files[1]['data']['X'])
y=(files[0]['data']['Y'],files[1]['data']['Y'])
hdu={}
hdu['data']={'x1': [], 'x2': [], 'y1': [], 'y2': [], 'mag1': [], 'mag2': [], 'id1': [], 'id2': []}
hdu['format']={'x1': '%10.2f',
               'x2': '%10.2f',
               'y1': '%10.2f',
               'y2': '%10.2f',
               'mag1': '%10.2f',
               'mag2': '%10.2f',
               'id1': '%10d',
               'id2': '%10d'
               }
hdu['order']=['x1','y1','mag1','x2','y2','mag2','id1','id2']
hdu['header']=files[1]['header']

id=0
for i in range(len(x[0])):
    pos1={'X': float(x[0][i]), 'Y': float(y[0][i])}
    for j in range(len(x[1])):
    	pos2={'X': float(x[1][j]), 'Y': float(y[1][j])}
	if (math.sqrt((pos1['X']-pos2['X'])**2 + (pos1['Y']-pos2['Y'])**2)<1):
	    if float(files[0]['data']['FLUX'][i])>0 and float(files[1]['data']['FLUX'][j]) > 0 :
	        try: 
	            hdu['data']['mag1'].append(1.5*math.log(float(files[0]['data']['FLUX'][i])))
	            hdu['data']['mag2'].append(1.5*math.log(float(files[1]['data']['FLUX'][j])))
		except:
		    sys.stderr.write('%f %d, %f %d \n' % ( float(files[0]['data']['FLUX'][i]) , i ,float(files[1]['data']['FLUX'][j]),j))
		    continue
	        hdu['data']['x1'].append(pos1['X'])
	        hdu['data']['x2'].append(pos2['X'])
	        hdu['data']['y1'].append(pos1['Y'])
	        hdu['data']['y2'].append(pos2['Y'])
		hdu['data']['id1'].append(i)
		hdu['data']['id2'].append(j)
	        id+=1



mop_files.write(basename+'.obj.mrg',hdu,format=hdu['format'],order=hdu['order'])

